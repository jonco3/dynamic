# @configure_input@

# Package-related substitution variables
package        = @PACKAGE_NAME@
version        = @PACKAGE_VERSION@
tarname        = @PACKAGE_TARNAME@

# Prefix-related substitution variables
prefix         = @prefix@
exec_prefix    = @exec_prefix@
bindir         = @bindir@

# VPATH-related substitution variables
srcdir         = @srcdir@
VPATH          = @srcdir@

CXX            = @CXX@
LD             = @CXX@

FLAGS          = -Wall -Werror --std=c++14
CXXFLAGS       = @CXXFLAGS@ $(FLAGS) -I.. -include config.h
LDFLAGS        = @LDFLAGS@ $(FLAGS) -lm

TESTCXXFLAGS   = -DBUILD_TESTS
TESTLDFLAGS    = 
MAINCXXFLAGS   = -DUSE_READLINE
MAINLDFLAGS    = -lreadline

SRCS = \
	src/token.cpp \
	src/parser.cpp \
	src/gc.cpp \
	src/block.cpp \
	src/layout.cpp \
	src/value.cpp \
	src/object.cpp \
	src/singletons.cpp \
	src/bool.cpp \
	src/frame.cpp \
	src/callable.cpp \
	src/interp.cpp \
	src/common.cpp \
	src/exception.cpp \
	src/integer.cpp \
	src/string.cpp \
	src/syntax.cpp \
	src/list.cpp \
	src/dict.cpp \
	src/builtin.cpp \
	src/instr.cpp \
	src/specials.cpp \
	src/generator.cpp \
	src/reflect.cpp

TESTSRCS = src/test.cpp $(SRCS)
MAINSRCS = src/main.cpp $(SRCS)

TESTOBJS = $(subst src,build/test,$(TESTSRCS:.cpp=.o))
MAINOBJS = $(subst src,build/main,$(MAINSRCS:.cpp=.o))

TESTDEPS = $(TESTOBJS:.o=.d)
MAINDEPS = $(MAINOBJS:.o=.d)

WRAPPER = python $(srcdir)/test/debug-wrapper
TEST-RUNNER = python $(srcdir)/test/run-tests

.PHONY: all
all: dynamic tests

Makefile: Makefile.in config.status
	./config.status $@

config.status: configure
	./config.status --recheck

unittests: $(TESTOBJS) Makefile
	$(LD) $(TESTOBJS) $(FLAGS) $(LDFLAGS) $(TESTLDFLAGS) -o unittests

dynamic: $(MAINOBJS) Makefile
	$(LD) $(MAINOBJS) $(FLAGS) $(LDFLAGS) $(MAINLDFLAGS) -o dynamic

.PHONY: unittest
unittest: unittests
	@echo "Entering directory \`@srcdir@/src'"
	$(WRAPPER) unittests -l $(srcdir)/lib

.PHONY: pythontest
pythontest: dynamic
	$(TEST-RUNNER) ./dynamic -l $(srcdir)/lib

.PHONY: test
test: unittest pythontest

.PHONY: bench
bench: dynamic
	python benchmarks/run_benchmarks.py

.PHONY: clean
clean:
	rm -f build/*/* dynamic tests

-include $(TESTDEPS)
-include $(MAINDEPS)

build/test/%.o: $(srcdir)/src/%.cpp Makefile
	mkdir -p build/test
	$(CXX) -c -MMD $(FLAGS) $(CXXFLAGS) $(TESTCXXFLAGS) $< -o $@

build/main/%.o: $(srcdir)/src/%.cpp Makefile
	mkdir -p build/main
	$(CXX) -c -MMD $(FLAGS) $(CXXFLAGS) $(MAINCXXFLAGS) $< -o $@
