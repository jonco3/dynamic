# @configure_input@

# Package-related substitution variables
package        = @PACKAGE_NAME@
version        = @PACKAGE_VERSION@
tarname        = @PACKAGE_TARNAME@

# Prefix-related substitution variables
prefix         = @prefix@
exec_prefix    = @exec_prefix@
bindir         = @bindir@

# VPATH-related substitution variables
srcdir         = @srcdir@
VPATH          = @srcdir@

CXX            = @CXX@
LD             = @CXX@

FLAGS          = -Wall -Werror --std=c++14
CXXFLAGS       = @CXXFLAGS@ $(FLAGS) -I.. -include config.h -DUSE_READLINE
LDFLAGS        = @LDFLAGS@ $(FLAGS) -lm -lreadline

SRCS = \
	src/name.cpp \
	src/token.cpp \
	src/parser.cpp \
	src/gc.cpp \
	src/block.cpp \
	src/analysis.cpp \
	src/compiler.cpp \
	src/layout.cpp \
	src/value.cpp \
	src/object.cpp \
	src/singletons.cpp \
	src/bool.cpp \
	src/frame.cpp \
	src/callable.cpp \
	src/interp.cpp \
	src/common.cpp \
	src/exception.cpp \
	src/numeric.cpp \
	src/string.cpp \
	src/syntax.cpp \
	src/list.cpp \
	src/dict.cpp \
	src/builtin.cpp \
	src/instr.cpp \
	src/specials.cpp \
	src/generator.cpp \
	src/reflect.cpp

MAINSRCS = src/main.cpp $(SRCS)
TESTSRCS = src/unittests.cpp $(SRCS)
ALLSRCS = src/main.cpp src/unittests.cpp $(SRCS)

TESTOBJS = $(subst src,build,$(TESTSRCS:.cpp=.o))
MAINOBJS = $(subst src,build,$(MAINSRCS:.cpp=.o))
ALLOBJS = $(subst src,build,$(ALLSRCS:.cpp=.o))

DEPS = $(ALLOBJS:.o=.d)

WRAPPER = python $(srcdir)/test/debug-wrapper
TEST-RUNNER = python $(srcdir)/test/run-tests

.PHONY: all
all: dynamic

Makefile: Makefile.in config.status
	./config.status $@

config.status: configure
	./config.status --recheck

unittests: $(TESTOBJS) Makefile
	/usr/bin/time $(LD) $(TESTOBJS) $(FLAGS) $(LDFLAGS) $(TESTLDFLAGS) -o unittests

dynamic: $(MAINOBJS) Makefile
	/usr/bin/time $(LD) $(MAINOBJS) $(FLAGS) $(LDFLAGS) $(MAINLDFLAGS) -o dynamic

build/gcapitest: src/gc.h $(srcdir)/test/gc-api-tests.py
	mkdir -p build
	python $(srcdir)/test/gc-api-tests.py
	touch build/gcapitest

.PHONY: gcapitest
gcapitest: build/gcapitest

# todo: gcapitest disabled for different error messages given by different
# compiler versions

.PHONY: unittest
unittest: unittests # gcapitest
	@echo "Entering directory \`@srcdir@/src'"
	$(WRAPPER) unittests -l $(srcdir)/lib

.PHONY: pythontest
pythontest: dynamic unittest
	$(TEST-RUNNER) ./dynamic -l $(srcdir)/lib

.PHONY: test
test: pythontest

.PHONY: bench
bench: dynamic
	python benchmarks/run_benchmarks.py

.PHONY: clean
clean:
	rm -rf build/* dynamic unittests

-include $(DEPS)

build/%.o: $(srcdir)/src/%.cpp Makefile
	mkdir -p build/test
	/usr/bin/time $(CXX) -c -MMD $(FLAGS) $(CXXFLAGS) $< -o $@
