# @configure_input@

# Package-related substitution variables
package        = @PACKAGE_NAME@
version        = @PACKAGE_VERSION@
tarname        = @PACKAGE_TARNAME@

# Prefix-related substitution variables
prefix         = @prefix@
exec_prefix    = @exec_prefix@
bindir         = @bindir@

# VPATH-related substitution variables
srcdir         = @srcdir@
VPATH          = @srcdir@

CXX            = @CXX@
LD             = @CXX@

FLAGS          = -Wall -Werror --std=c++14
CXXFLAGS       = @CXXFLAGS@ $(FLAGS) -I.. -include config.h -DUSE_READLINE
LDFLAGS        = @LDFLAGS@ $(FLAGS) -lm -lreadline

SRCS = \
	src/token.cpp \
	src/parser.cpp \
	src/gc.cpp \
	src/block.cpp \
	src/layout.cpp \
	src/value.cpp \
	src/object.cpp \
	src/singletons.cpp \
	src/bool.cpp \
	src/frame.cpp \
	src/callable.cpp \
	src/interp.cpp \
	src/common.cpp \
	src/exception.cpp \
	src/numeric.cpp \
	src/string.cpp \
	src/syntax.cpp \
	src/list.cpp \
	src/dict.cpp \
	src/builtin.cpp \
	src/instr.cpp \
	src/specials.cpp \
	src/generator.cpp \
	src/reflect.cpp

TEST_SRCS = \
	src/test/test_token.cpp \
	src/test/test_parser.cpp \
	src/test/test_gc.cpp \
	src/test/test_block.cpp \
	src/test/test_layout.cpp \
	src/test/test_object.cpp \
	src/test/test_interp.cpp \
	src/test/test_exception.cpp \
	src/test/test_numeric.cpp \
	src/test/test_string.cpp \
	src/test/test_list.cpp \
	src/test/test_dict.cpp \
	src/test/test_builtin.cpp

MAINSRCS = src/main.cpp $(SRCS)
TESTSRCS = src/test.cpp $(TEST_SRCS) $(SRCS)

TESTOBJS = $(subst src,build,$(TESTSRCS:.cpp=.o))
MAINOBJS = $(subst src,build,$(MAINSRCS:.cpp=.o))

TESTDEPS = $(TESTOBJS:.o=.d)
MAINDEPS = $(MAINOBJS:.o=.d)

WRAPPER = python $(srcdir)/test/debug-wrapper
TEST-RUNNER = python $(srcdir)/test/run-tests

.PHONY: all
all: dynamic

Makefile: Makefile.in config.status
	./config.status $@

config.status: configure
	./config.status --recheck

unittests: $(TESTOBJS) Makefile
	$(LD) $(TESTOBJS) $(FLAGS) $(LDFLAGS) $(TESTLDFLAGS) -o unittests

dynamic: $(MAINOBJS) Makefile
	$(LD) $(MAINOBJS) $(FLAGS) $(LDFLAGS) $(MAINLDFLAGS) -o dynamic

build/gcapitest: src/gc.h $(srcdir)/test/gc-api-tests.py
	mkdir -p build
	python $(srcdir)/test/gc-api-tests.py
	touch build/gcapitest

.PHONY: gcapitest
gcapitest: build/gcapitest

.PHONY: unittest
unittest: unittests gcapitest
	@echo "Entering directory \`@srcdir@/src'"
	$(WRAPPER) unittests -l $(srcdir)/lib

.PHONY: pythontest
pythontest: dynamic unittest
	$(TEST-RUNNER) ./dynamic -l $(srcdir)/lib

.PHONY: test
test: pythontest

.PHONY: bench
bench: dynamic
	python benchmarks/run_benchmarks.py

.PHONY: clean
clean:
	rm -rf build/* dynamic unittests

-include $(TESTDEPS)
-include $(MAINDEPS)

build/%.o: $(srcdir)/src/%.cpp Makefile
	mkdir -p build/test
	$(CXX) -c -MMD $(FLAGS) $(CXXFLAGS) $< -o $@
