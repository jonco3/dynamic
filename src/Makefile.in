# @configure_input@

# Package-related substitution variables
package        = @PACKAGE_NAME@
version        = @PACKAGE_VERSION@
tarname        = @PACKAGE_TARNAME@
distdir        = $(tarname)-$(version)

# Prefix-related substitution variables
prefix         = @prefix@
exec_prefix    = @exec_prefix@
bindir         = @bindir@

# VPATH-related substitution variables
srcdir         = @srcdir@
VPATH          = @srcdir@

CXX            = @CXX@
LD             = @CXX@

FLAGS          = -Wall -Werror --std=c++11 # --stdlib=libc++
CXXFLAGS       = @CXXFLAGS@ $(FLAGS) -I.. -include config.h
LDFLAGS        = @LDFLAGS@ $(FLAGS) -lstdc++ -lm

Makefile: Makefile.in ../config.status
	cd .. && ./config.status $@

../config.status: ../configure
	cd .. && ./config.status --recheck

TESTCXXFLAGS = -DBUILD_TESTS
TESTLDFLAGS = 
MAINCXXFLAGS = -DUSE_READLINE
MAINLDFLAGS = -lreadline

SRCS = \
	src/token.cpp \
	src/parser.cpp \
	src/gc.cpp \
	src/block.cpp \
	src/layout.cpp \
	src/value.cpp \
	src/object.cpp \
	src/singletons.cpp \
	src/bool.cpp \
	src/frame.cpp \
	src/callable.cpp \
	src/interp.cpp \
	src/common.cpp \
	src/exception.cpp \
	src/integer.cpp \
	src/string.cpp \
	src/list.cpp \
	src/dict.cpp \
	src/builtin.cpp \
	src/instr.cpp \
	src/specials.cpp \
	src/generator.cpp

TESTSRCS = src/test.cpp $(SRCS)
MAINSRCS = src/main.cpp $(SRCS)

TESTOBJS = $(subst src,build/test,$(TESTSRCS:.cpp=.o))
MAINOBJS = $(subst src,build/main,$(MAINSRCS:.cpp=.o))

.PHONY: all
all: dynamic tests

tests: $(TESTOBJS) Makefile
	$(LD) $(TESTOBJS) $(FLAGS) $(LDFLAGS) $(TESTLDFLAGS) -o tests

dynamic: $(MAINOBJS) Makefile
	$(LD) $(MAINOBJS) $(FLAGS) $(LDFLAGS) $(MAINLDFLAGS) -o dynamic

WRAPPER = python test/debug-wrapper
TEST-RUNNER = python test/run-tests
.PHONY: test
test: tests dynamic
	@echo "Entering directory \`src'"
	@$(WRAPPER) tests
	@$(TEST-RUNNER) dynamic

.PHONY: bench
bench: dynamic
	python benchmarks/run_benchmarks.py

.PHONY: clean
clean:
	rm -f build/*/* dynamic tests

-include $(TESTDEPS)
-include $(MAINDEPS)

build/test/%.o: $(srcdir)/%.cpp Makefile
	mkdir -p build/test
	$(CXX) -c -MMD $(FLAGS) $(CXXFLAGS) $(TESTCXXFLAGS) $< -o $@

build/main/%.o: $(srcdir)/%.cpp Makefile
	mkdir -p build/main
	$(CXX) -c -MMD $(FLAGS) $(CXXFLAGS) $(MAINCXXFLAGS) $< -o $@
